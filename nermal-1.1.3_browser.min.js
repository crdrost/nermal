/* nermal v 1.1.3 | (c) 2017 Chris Drost
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
nermal=(function(){var A,B,C,D,G,V="nermal 1.1.3333",H=/^nermal 1\./,w=window,E=function(a,b){return new Error("nermal/"+a+": "+b)},F=function(b){var x=[],i,l=b.length%4,e=b.length-l;for(i=0;i<e;i+=4){x.push(b[i]<<24|b[i+1]<<16|b[i+2]<<8|b[i+3])}if(l!==0){x.push(B.bitArray.partial(l*8,l===1?b[i]:l===2?b[i]<<8|b[i+1]:b[i]<<16|b[i+1]<<8|b[i+2]))}return x};G=function(x){var i,k,b=new Uint8Array(B.bitArray.bitLength(x)/8);for(i=k=0;k<x.length;k++){b[i++]=x[k]>>24;b[i++]=x[k]>>16;b[i++]=x[k]>>8;b[i++]=x[k]}return b};if(w.sjcl&&w.scrypt_module_factory){B=w.sjcl;C=w.scrypt_module_factory(Math.pow(2,27))}else{throw E("lib","Could not find sjcl and js-scrypt-em.");}if(w.crypto&&w.crypto.getRandomValues){D=function(n){var b=new Uint8Array(n);w.crypto.getRandomValues(b);return b}}else{throw E("rand","No source of random data seems to be available.");}if(w.btoa&&w.atob){A={enc:function(a){return w.btoa(String.fromCharCode.apply(String,a))},dec:function(a){var d=w.atob(a),i,b=new Uint8Array(d.length);for(i=0;i<d.length;i++){b[i]=d.charCodeAt(i)}return b}}}else{throw E("bad_browser","The Base64 library requires a browser which supports atob() and btoa()");}function kdf(s,p){return{salt:s,key:C.crypto_scrypt(C.encode_utf8(p),s,16384,8,1,32)}}function pad(b){if(!(b instanceof Uint8Array)){throw E("type","nermal._pad() requires a Uint8Array.");}var l=Math.floor(Math.random()*2048),q=D(l),n=C.encode_utf8(b.length+":"),p=new Uint8Array(n.length+b.length+l+1);p.set(n,0);p.set(b,n.length);p[b.length+n.length]=44;p.set(q,n.length+b.length+1);return p}function unpad(b){var i=0,s,e;while(b[i]!==":".charCodeAt(0)&&i<b.length){i+=1}try{s=C.decode_utf8(b.subarray(0,i));if(i<b.length&&/^(?:0|[1-9][0-9]*)$/.exec(s)){e=i+1+parseInt(s,10);if(e<=b.length){return b.subarray(i+1,e)}}}catch(I){}throw E("unpad","Byte array was not formatted by nermal._pad()");}function getKey(b,p){return kdf(A.dec(b.split("\n")[1]),p)}function newKey(p){return kdf(D(30),p)}function S(r,v,s,u){if(typeof v==="string"){return s(v)}if(v===undefined&&u){return u()}if(v instanceof Uint8Array){return v}throw E("type","Parameter `"+r+"` was not a string or Uint8Array.");}return{_b64:A,_kdf:kdf,_pad:pad,_unpad:unpad,version:V,newKey:newKey,getKey:getKey,encrypt:function encrypt(a,b,c,d){if(typeof a!=="string"){throw E("namespace","Namespace was not a string.");}if(a[0]===" "){throw E("namespace","Namespaces cannot begin with space characters.");}a=a===""?V:a+"/"+V;var e=typeof c==="string"?newKey(c):c,ba_key=F(S("key",e.key,A.dec)),salt=S("salt",e.salt,A.dec);d=S("nonce",d,A.dec,D.bind(D,16));b=S("data",b,C.encode_utf8);return JSON.stringify(a).slice(1,-1)+"\n"+A.enc(salt)+"\n"+A.enc(d)+"\n"+B.codec.base64.fromBits(B.mode.gcm.encrypt(new B.cipher.aes(ba_key),F(pad(b)),F(d),B.codec.utf8String.toBits(a),128))+"\n"},decrypt:function decrypt(a,b,c){if(typeof a!=="string"){throw E("type","Parameter `box` was not a string.");}b=typeof b==="string"?getKey(a,b):b;var d=a.trim().split("\n").map(function(s){return JSON.parse('"'+s.trim()+'"')}),ns=d[0].split("/"),data;if(H.exec(ns[ns.length-1])===null){throw E('incompatible','String does not report being a '+V.slice(0,V.indexOf('.'))+'.x box.');}try{data=unpad(G(B.mode.gcm.decrypt(new B.cipher.aes(F(b.key)),B.codec.base64.toBits(d.slice(3).join("")),B.codec.base64.toBits(d[2]),B.codec.utf8String.toBits(d[0]),128)))}catch(e){throw E('decrypt',"Decryption error: "+e);}try{return c===true?data:B.codec.utf8String.fromBits(F(data))}catch(e){throw E('utf8',"The wrapped bytes are not a UTF-8 formatted string.");}}}}());
